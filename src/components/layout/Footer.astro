---
import fs from "node:fs";
import path from "node:path";
import { footerConfig, profileConfig } from "@/config";
import { url } from "@/utils/url-utils";
import { Icon } from "astro-icon/components";
import SiteStats from "@/components/widget/SiteStats.astro";

const currentYear = new Date().getFullYear();

// 读取FooterConfig.html文件内容
let customFooterHtml = "";
if (footerConfig.enable) {
	try {
		const footerConfigPath = path.join(
			process.cwd(),
			"src",
			"config",
			"FooterConfig.html",
		);
		customFooterHtml = fs.readFileSync(footerConfigPath, "utf-8");
		// 移除HTML注释
		customFooterHtml = customFooterHtml.replace(/<!--[\s\S]*?-->/g, "").trim();
	} catch (error) {
		console.warn("FooterConfig.html文件读取失败:", error.message);
	}
}
---


<footer class="w-full mt-4">
	<div class="max-w-(--page-width) mx-auto py-4 onload-animation px-2 md:px-4 flex items-center justify-between">
		<div class="text-center text-sm text-50">
			<div class="mb-2">
				{customFooterHtml && <div set:html={customFooterHtml} />}
			</div>
			<div class="m-0.5">
				&copy; <span id="copyright-year">{currentYear}</span>
				{profileConfig.name}. All Rights Reserved. /
				<a
					class="transition link text-(--primary) font-medium"
					target="_blank"
					href={url("rss.xml")}>RSS</a
				> /
				<a
					class="transition link text-(--primary) font-medium"
					target="_blank"
					href={url("sitemap-index.xml")}>Sitemap</a
				>
			</div>
			<div class="m-0.5">
				Powered by
				<a
					class="transition link text-(--primary) font-medium"
					target="_blank"
					href="https://astro.build">Astro</a
				> &
				<a
					class="transition link text-(--primary) font-medium"
					target="_blank"
					href="https://github.com/CuteLeaf/Firefly">Firefly</a
				>
			</div>
			<!-- 
			注意：请勿随意修改或删除 "Powered by Astro & Firefly" 部分，这是对开源项目的尊重和支持。
			如果您需要在底部增加内容，请在src/config/footerConfig.ts中修改enable属性为true，然后编辑src/config/FooterConfig.html文件。
			您可以随意在src/config/FooterConfig.html中随意添加自定义内容，不需要修改Footer.astro文件。
			-->
		</div>
        <div class="relative flex justify-center mt-4">
            <button
                id="stats-dropdown-button"
                class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90 flex items-center justify-center"
                aria-label="Site Statistics"
            >
                <Icon name="material-symbols:query-stats" class="text-[1.25rem]" />
            </button>
            <div
                id="stats-dropdown-panel"
                class="float-panel float-panel-closed absolute bottom-full mb-2 w-72 z-50"
            >
                <SiteStats />
            </div>
        </div>
	</div>
</footer>

<style>
  footer > div {
    background: var(--card-bg);
    border: 1px solid var(--line-divider);
    border-bottom: none; /* Footer is at the bottom */
    border-radius: 0.75rem 0.75rem 0 0;
    transition: all var(--duration-medium) var(--ease-standard);
    box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.05); /* Shadow upwards */
    max-width: calc(var(--page-width) - 2rem);
  }

  :root.dark footer > div {
    box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
  }
</style>

<script is:inline>
  const button = document.getElementById("stats-dropdown-button");
  const menu = document.getElementById("stats-dropdown-panel");

  if (button && menu) {
    let isOpen = false;

    function toggleDropdown() {
      isOpen = !isOpen;
      if (isOpen) {
        menu.classList.remove("float-panel-closed");
      } else {
        menu.classList.add("float-panel-closed");
      }
    }

    function closeDropdown(event) {
      if (isOpen && !menu.contains(event.target) && !button.contains(event.target)) {
        isOpen = false;
        menu.classList.add("float-panel-closed");
      }
    }

    button.addEventListener("click", toggleDropdown);
    document.addEventListener("click", closeDropdown);
    
    // Cleanup on navigation
    document.addEventListener('astro:before-swap', () => {
      document.removeEventListener('click', closeDropdown);
    });
    document.addEventListener('astro:after-swap', () => {
        // Re-add the listener after a page swap
        document.addEventListener('click', closeDropdown);
    });
  }
</script>
