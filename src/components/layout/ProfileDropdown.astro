---
import { profileConfig } from "@/config/profileConfig";
import { i18n } from "@/i18n/translation";
import I18nKey from "@/i18n/i18nKey";
import { Picture } from "astro:assets";
import type { ImageMetadata } from "astro";
import AvatarImage from "@/components/common/AvatarImage.astro";
import DropdownPanel from "@/components/common/DropdownPanel.astro";
import { Icon } from "astro-icon/components";
import ImageWrapper from "@/components/common/ImageWrapper.astro";
import { url } from "@/utils/url-utils";

const profileName = profileConfig.name;

let profileAvatarOptimized: ImageMetadata | undefined = undefined;
let profileAvatarDirectPath: string | undefined = undefined;

if (profileConfig.avatar) {
    if (profileConfig.avatar.startsWith("/") || profileConfig.avatar.startsWith("http")) {
        profileAvatarDirectPath = profileConfig.avatar;
    } else {
        const images = await import.meta.glob<{ default: ImageMetadata }>("/src/assets/images/**/*.{avif,png,jpg,jpeg,webp,gif,svg}");
        const imagePath = `/src/${profileConfig.avatar}`;
        if (images[imagePath]) {
            profileAvatarOptimized = (await images[imagePath]()).default;
        } else {
            // Image not found, maybe just use direct path as fallback
            profileAvatarDirectPath = profileConfig.avatar;
        }
    }
}


const buttonClassName = "h-9 w-9 rounded-lg";
const buttonWidths = [36, 72];
---



<div class="profile-dropdown-container relative">
    <button
    id="profile-dropdown-button"
    class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90 flex items-center justify-center"
  >
    <AvatarImage
      profileAvatarOptimized={profileAvatarOptimized}
      profileAvatarDirectPath={profileAvatarDirectPath}
      profileName={profileName}
      className={buttonClassName}
      widths={buttonWidths}
      loading="eager"
    />
  </button>
    <DropdownPanel
    id="profile-dropdown-menu"
    class="float-panel float-panel-closed absolute right-0 w-64 z-50 card-base p-3"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="profile-dropdown-button"
  >
    <div class="card-base p-3">
  <a
    aria-label="Go to About Page"
    href={url("/about/")}
    class="group block relative mx-auto mt-1 lg:mx-0 lg:mt-0 mb-3
       max-w-48 lg:max-w-none overflow-hidden rounded-xl active:scale-95"
  >
    <div
      class="absolute transition pointer-events-none group-hover:bg-black/30 group-active:bg-black/50
        w-full h-full z-50 flex items-center justify-center"
    >
      <Icon
        name="fa7-regular:address-card"
        class="transition opacity-0 scale-90 group-hover:scale-100 group-hover:opacity-100 text-white text-5xl"
      />
    </div>
    <ImageWrapper
      src={profileConfig.avatar || ""}
      alt="Profile Image of the Author"
      class="mx-auto lg:w-full h-full lg:mt-0"
      loading="eager"
      fetchpriority="high"
      widths={[350]}
      sizes="350px"
    />
  </a>
  <div class="px-2">
    <div
      class="font-bold text-xl text-center mb-1 dark:text-neutral-50 transition"
    >
      {profileConfig.name}
    </div>
    <div
      class="h-1 w-5 bg-(--primary) mx-auto rounded-full mb-2 transition"
    >
    </div>
    <div class="text-center text-neutral-400 mb-2.5 transition">
      {profileConfig.bio}
    </div>
        <div class="flex flex-wrap gap-2 justify-center mb-1">
            {profileConfig.links.length > 1 && profileConfig.links.map(item =>
                    {
                    const showName = item.showName;
                    const className = showName 
                        ? "btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95" 
                        : "btn-regular rounded-lg h-10 w-10 active:scale-90";

                    if (item.url.startsWith("mailto:")) { // Lógica de ofuscación de correo electrónico
                        const encodedEmail = btoa(item.url.replace("mailto:", "")); // Usar btoa para codificar en base64 en el navegador
                        return <a rel="me" aria-label={item.name} href="#" data-encoded-email={encodedEmail} onclick={`
                                            (function() {
                                                const encodedEmail = this.getAttribute('data-encoded-email');
                                                const decodedEmail = atob(encodedEmail);
                                                this.href = 'mailto:' + decodedEmail;
                                                this.removeAttribute('data-encoded-email');
                                                this.removeAttribute('onclick');
                                                this.click();
                                                return false;
                                            }).call(this);
                                        `.replace(/\s+/g, " ").trim()
                                    },
                                    class={className}>
                            <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                            {showName && item.name}
                        </a>
                    } else {
                        return <a rel="me" aria-label={item.name} href={item.url} target="_blank" class={className}>
                            {item.icon && <Icon name={item.icon} class="text-[1.5rem]"></Icon>}
                            {showName && item.name}
                        </a> // Asegurarse de que los iconos se rendericen
                    }
                    }
            )}
            {profileConfig.links.length == 1 && (function(item){
                if (item.url.startsWith("mailto:")) { // Lógica de ofuscación de correo electrónico
                        const encodedEmail = btoa(item.url.replace("mailto:", "")); // Usar btoa para codificar en base64 en el navegador
                        return <a rel="me" aria-label={item.name} href="#" data-encoded-email={encodedEmail} onclick={`
                                            (function() {
                                                const encodedEmail = this.getAttribute('data-encoded-email');
                                                const decodedEmail = atob(encodedEmail);
                                                this.href = 'mailto:' + decodedEmail;
                                                this.removeAttribute('data-encoded-email');
                                                this.removeAttribute('onclick');
                                                this.click();
                                                return false;
                                            }).call(this);
                                        `.replace(/\s+/g, " ").trim()} class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95 flex items-center justify-center w-full">
                {item.icon && <Icon name={item.icon} class="text-[1.5rem]"></Icon>}
                            {item.name}
                        </a>
                    } else {
                        return <a rel="me" aria-label={item.name} href={item.url} target="_blank"
                                            class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95 flex items-center justify-center w-full">
                {item.icon && <Icon name={item.icon} class="text-[1.5rem]"></Icon>}
                                {item.name}
                            </a>
                    }
            })(profileConfig.links[0])}
        </div>
  </div>
</div>
  </DropdownPanel>

<!-- 

<div class="relative profile-dropdown-container">
  <button
    id="profile-dropdown-button"
    class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90 flex items-center justify-center focus:outline-none"
    aria-label={profileLabel}
    aria-haspopup="true"
    aria-expanded="false"
  >
    <AvatarImage
      profileAvatarOptimized={profileAvatarOptimized}
      profileAvatarDirectPath={profileAvatarDirectPath}
      profileName={profileName}
      className={buttonClassName}
      widths={buttonWidths}
      loading="eager"
    />
  </button>

  <DropdownPanel
    id="profile-dropdown-menu"
    class="absolute right-0 mt-2 w-64 float-panel-closed transition-all duration-200 z-50 dropdown-content card-base p-3"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="profile-dropdown-button"
  >
    <div class="p-4 text-center">
      <AvatarImage
        profileAvatarOptimized={profileAvatarOptimized}
        profileAvatarDirectPath={profileAvatarDirectPath}
        profileName={profileName}
        className={dropdownClassName}
        widths={dropdownWidths}
        loading="eager"
      />
      <h3 class="text-lg font-semibold text-[var(--text-color)]">{profileName}</h3>
      {profileBio && <p class="text-sm text-[var(--text-color-light)]">{profileBio}</p>}
    </div>
    <div class="border-t border-(--line-divider) mx-4"></div>
    <ul class="py-1" role="none">
      {
        profileLinks.map((link) => (
          <li>
            <a
              href={link.url}
              target={link.external ? "_blank" : "_self"}
              rel={link.external ? "noopener noreferrer" : ""}
              class="flex items-center px-4 py-3 text-sm text-[var(--text-color)] hover:bg-(--float-panel-hover) transition-colors"
              role="menuitem"
            >
              {link.showName && <span class="ml-2">{link.name}</span>}
            </a>
          </li>
        ))
      }
    </ul>
  </div>
</div> -->

<script is:inline>
  const button = document.getElementById("profile-dropdown-button");
  const menu = document.getElementById("profile-dropdown-menu");

  let isOpen = false;

  function toggleDropdown() {
    isOpen = !isOpen;
    if (isOpen) {
      menu.classList.remove("float-panel-closed");
      button.setAttribute("aria-expanded", "true");
    } else {
      menu.classList.add("float-panel-closed");
      button.setAttribute("aria-expanded", "false");
    }
  }

  function closeDropdown(event) {
    if (isOpen && !menu.contains(event.target) && !button.contains(event.target)) {
      isOpen = false;
      menu.classList.add("float-panel-closed");
      button.setAttribute("aria-expanded", "false");
    }
  }

  button.addEventListener("click", toggleDropdown);
  document.addEventListener("click", closeDropdown);

  // Cleanup on navigation (for SPA-like behavior in Astro)
  document.addEventListener('astro:before-swap', () => {
    document.removeEventListener('click', closeDropdown);
  });
  document.addEventListener('astro:after-swap', () => {
    document.addEventListener('click', closeDropdown);
  });
</script>
