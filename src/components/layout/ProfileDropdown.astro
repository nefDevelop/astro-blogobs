---
import { profileConfig } from "@/config/profileConfig";
import { getIconSvg } from "@/constants/icons";
import { i18n } from "@/i18n/translation";
import I18nKey from "@/i18n/i18nKey";
import { Picture } from "astro:assets";
import type { ImageMetadata } from "astro";
import DropdownItem from "@/components/common/DropdownItem.astro";
import AvatarImage from "@/components/common/AvatarImage.astro";
import DropdownPanel from "@/components/common/DropdownPanel.astro";

const profileName = profileConfig.name;
const profileBio = profileConfig.bio;
const profileAvatarConfigPath = profileConfig.avatar;
let profileAvatarOptimized: ImageMetadata | undefined = undefined;
let profileAvatarDirectPath: string | undefined = undefined;

const isLocalSrcAvatar = profileAvatarConfigPath && !profileAvatarConfigPath.startsWith("/") && !profileAvatarConfigPath.startsWith("http");

if (isLocalSrcAvatar) {
  const files = import.meta.glob<ImageMetadata>(
    "/src/assets/images/**/*.{png,jpg,jpeg,webp,avif,gif,svg}",
    { import: "default" },
  );
  const globKey = `/src/${profileAvatarConfigPath}`;
  const file = files[globKey];
  if (file) {
    profileAvatarOptimized = await file();
  } else {
    profileAvatarDirectPath = profileAvatarConfigPath;
  }
} else {
  profileAvatarDirectPath = profileAvatarConfigPath;
}

const profileLabel = i18n(I18nKey.profile);

function getAvatarElement(isSmall: boolean) {
  const widths = isSmall ? [44, 88] : [64, 128];
  const className = isSmall
    ? "w-8 h-8 object-cover rounded-full"
    : "w-16 h-16 object-cover rounded-full mx-auto mb-2";
  return { widths, className };
}

const { widths: buttonWidths, className: buttonClassName } = getAvatarElement(true);
const { widths: dropdownWidths, className: dropdownClassName } = getAvatarElement(false);
const profileLinks = profileConfig.links;
---

<div class="relative profile-dropdown-container">
  <button
    id="profile-dropdown-button"
    class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90 flex items-center justify-center focus:outline-none"
    aria-label={profileLabel}
    aria-haspopup="true"
    aria-expanded="false"
  >
    <AvatarImage
      profileAvatarOptimized={profileAvatarOptimized}
      profileAvatarDirectPath={profileAvatarDirectPath}
      profileName={profileName}
      className="w-8 h-8 object-cover rounded-full" {/* Ajustar el tama침o del avatar dentro del bot칩n */}
      widths={buttonWidths}
      loading="eager"
    />
  </button>

  <DropdownPanel
    id="profile-dropdown-menu"
    class="absolute right-0 mt-2 w-64 float-panel-closed transition-all duration-200 z-50 !p-3 bg-white/80 dark:bg-black/80 border border-black/10 dark:border-white/10 rounded-2xl shadow-2xl backdrop-blur-3xl"
    role="menu"
    aria-labelledby="profile-dropdown-button"
  >
    <div>
      <div class="flex flex-col items-center text-center mb-3">
        <AvatarImage
          profileAvatarOptimized={profileAvatarOptimized}
          profileAvatarDirectPath={profileAvatarDirectPath}
          profileName={profileName}
          className={dropdownClassName}
          widths={dropdownWidths}
          loading="eager"
        />
        <h3 class="text-lg font-bold text-black/90 dark:text-white/90 mt-2">{profileName}</h3>
        {profileBio && <p class="text-sm text-black/50 dark:text-white/50 line-clamp-2">{profileBio}</p>}
      </div>
      <div class="flex flex-wrap justify-center gap-1">
      {/* Separador */}
      <div class="border-t border-[var(--line-divider)] my-2 w-full"></div>
      <div class="flex flex-col gap-1 w-full"> {/* Asegurar que el contenedor de los DropdownItems ocupe todo el ancho */}
        {
          profileLinks.map((link) => (
            <DropdownItem
              href={link.url}
              title={link.name}
              target={link.external ? "_blank" : "_self"}
              rel={link.external ? "noopener noreferrer" : ""}
              role="menuitem" // DropdownItem ya tiene estilos de bot칩n, solo a침adir flex items-center
            >
              <span class="text-xl mr-2" set:html={getIconSvg(link.icon)} />
              <span class="text-black/75 dark:text-white/75">{link.name}</span> {/* Restaurar estilos de texto */}
            </DropdownItem>
          ))
        }
      </div>
    </div>
  </DropdownPanel>
</div>

<script is:inline>
  const button = document.getElementById("profile-dropdown-button");
  const menu = document.getElementById("profile-dropdown-menu");

  let isOpen = false;

  function toggleDropdown() {
    isOpen = !isOpen;
    if (isOpen) {
      menu.classList.remove("float-panel-closed");
      button.setAttribute("aria-expanded", "true");
    } else {
      menu.classList.add("float-panel-closed");
      button.setAttribute("aria-expanded", "false");
    }
  }

  function closeDropdown(event) {
    if (isOpen && !menu.contains(event.target) && !button.contains(event.target)) {
      isOpen = false;
      menu.classList.add("float-panel-closed");
      button.setAttribute("aria-expanded", "false");
    }
  }

  button.addEventListener("click", toggleDropdown);
  document.addEventListener("click", closeDropdown);

  // Cleanup on navigation (for SPA-like behavior in Astro)
  document.addEventListener('astro:before-swap', () => {
    document.removeEventListener('click', closeDropdown);
  });
  document.addEventListener('astro:after-swap', () => {
    document.addEventListener('click', closeDropdown);
  });
</script>